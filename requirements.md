# 画像 OCR 文字起こし Web アプリケーション
## 機能仕様書

──────────────────────────────

| 項目 | 内容 |
|------|------|
| バージョン | 1.1 |
| 作成日 | 2026年2月6日 |
| ステータス | ドラフト |
| 技術スタック | Streamlit + Google Gemini API (Gemini 2.0 Flash) |

---

## 概要

### プロジェクト概要

本ドキュメントは、ユーザーがアップロードした画像から文字を自動的に読み取り、テキストとして出力するOCR（光学文字認識）Webアプリケーションの機能仕様を定義する。OCR処理にはGoogleのGemini API（Gemini 2.0 Flashモデル）のビジョン機能を活用し、フロントエンドはStreamlitで実装する。

| 項目 | 内容 |
|------|------|
| プロジェクト名 | 画像 OCR 文字起こし Web アプリケーション |
| バージョン | 1.1 |
| 対象ユーザー | 画像内の文字をテキスト化したい一般ユーザー |
| 技術スタック | Streamlit / Python / Google Gemini API (Gemini 2.0 Flash) |
| デプロイ先 | Streamlit Community Cloud / オンプレミス |

---

## システム構成図

システムは以下の3層構成で動作する。

1. **プレゼンテーション層**: Streamlit UI（ブラウザ）
2. **アプリケーション層**: Python バックエンド（画像前処理・API呼び出し・結果整形）
3. **外部サービス層**: Google Gemini API（Gemini 2.0 Flash Vision）

---

## 機能要件

### F-001: 画像アップロード

ユーザーが画像ファイルをアプリケーションにアップロードする機能。

| 項目 | 詳細 |
|------|------|
| 対応フォーマット | JPEG, PNG, GIF, BMP, WebP, TIFF |
| ファイルサイズ上限 | 20MB（Gemini APIの制約に準拠） |
| アップロード方法 | `st.file_uploader` コンポーネントによるドラッグ＆ドロップまたはファイル選択 |
| 複数ファイル対応 | 対応（`accept_multiple_files=True`） |
| バリデーション | ファイル形式・サイズチェック、エラー時ユーザー通知 |

---

### F-002: 画像プレビュー

アップロードされた画像を処理前に確認できる機能。

- `st.image` でサムネイル表示
- ファイル名・サイズ・形式のメタ情報表示
- 複数ファイル時はカラムレイアウトで一覧表示

---

### F-003: OCR処理（Gemini API連携）

GoogleのGemini 2.0 Flashモデルのビジョン機能を利用し、画像内の文字を読み取る。

| 項目 | 詳細 |
|------|------|
| APIエンドポイント | Gemini API (google-genai Python SDK) |
| 使用モデル | `gemini-2.0-flash`（ビジョン対応） |
| 画像送信方法 | PIL Imageまたはbytesを直接 `generate_content()` に渡す |
| プロンプト | 「この画像内のすべての文字を正確に読み取ってください」 |
| レスポンス形式 | プレーンテキスト（マークダウン形式対応可） |
| タイムアウト | 60秒（デフォルト） |

#### APIリクエスト構造

以下の形式でGemini APIにリクエストを送信する。

```python
from google import genai
from PIL import Image

client = genai.Client(api_key="<API_KEY>")
image = Image.open(uploaded_file)

response = client.models.generate_content(
    model="gemini-2.0-flash",
    contents=[
        "<プロンプト>",
        image
    ]
)
```

---

### F-004: OCR結果表示

OCR処理の結果を画面上に表示する機能。

- 処理中は`st.spinner`でローディング表示
- 結果テキストを`st.text_area`で表示（編集可能）
- マークダウン形式の結果は`st.markdown`でレンダリング表示
- 画像と結果を並列表示（`st.columns`で左: 画像、右: テキスト）

---

### F-005: 結果ダウンロード

OCR結果をファイルとしてダウンロードする機能。

| 項目 | 詳細 |
|------|------|
| ダウンロード形式 | TXT（デフォルト）、Markdown (.md) |
| 実装方法 | `st.download_button` コンポーネント |
| ファイル名 | `ocr_result_<タイムスタンプ>.txt` |
| 文字コード | UTF-8 |

---

### F-006: クリップボードコピー

OCR結果をクリップボードにコピーする機能。`pyperclip`またはStreamlitの`st.code`コンポーネント（コピーボタン付き）で実現する。

---

### F-007: 言語・処理オプション

ユーザーがOCR処理の動作をカスタマイズできるオプション機能。

- **読み取り言語指定**: 自動検出（デフォルト）/ 日本語 / 英語 / その他
- **出力形式**: プレーンテキスト / マークダウン / 表形式（表が含まれる場合）
- **詳細度**: 正確な転写 / 要約付き転写

---

### F-008: APIキー管理

Google Gemini APIキーの入力・保存機能。

- サイドバーまたはモーダルでAPIキー入力（`st.text_input`, `type='password'`）
- `st.secrets`または環境変数によるサーバーサイド設定もサポート
- APIキー未設定時はエラーメッセージを表示しOCR実行をブロック

---

### F-009: カメラ撮影モード

デバイスのカメラを利用して直接撮影した画像をOCR処理にかける機能。書類やホワイトボードなどをファイル保存せずにその場で読み取れる。

#### 機能要件

| 項目 | 詳細 |
|------|------|
| 実装コンポーネント | `st.camera_input` |
| 入力切り替え | `st.radio` または `st.tabs` で「ファイルアップロード」と「カメラ撮影」を切替 |
| 対応デバイス | PC内蔵カメラ、スマートフォン背面/前面カメラ |
| 出力形式 | JPEG画像（`st.camera_input` の標準出力） |
| ファイルアップロードとの統合 | 撮影画像も既存のOCRパイプライン（F-003）で同一処理 |

#### ユーザーフロー

1. 入力方法のタブで「カメラ撮影」を選択する
2. ブラウザがカメラアクセス許可を求める（初回のみ）
3. カメラプレビューが表示され、撮影ボタンでキャプチャする
4. 撮影画像のプレビューが表示される
5. 「OCR実行」ボタンで通常と同様に処理を開始する

#### UI設計

| 項目 | 詳細 |
|------|------|
| タブ構成 | `st.tabs`（[「ファイルアップロード」, 「カメラ撮影」]） |
| カメラエリア | `st.camera_input(「撮影してください」)` |
| 撮影後プレビュー | `st.image` で撮影画像を表示 |
| 撮り直し | 再度撮影ボタンで上書き（`st.camera_input`の標準機能） |

#### エラーハンドリング

| エラーケース | 対応 |
|--------------|------|
| カメラアクセス拒否 | `st.warning` でブラウザ設定からカメラを許可するよう案内 |
| カメラ非対応ブラウザ | `st.info` でファイルアップロードの利用を推奨 |
| 撮影画像が不明瞭 | OCR結果が不十分な場合、撮り直しを促すメッセージを表示 |

#### 技術的考慮事項

- `st.camera_input` は HTTPS 環境が必須（localhost または SSL 証明書付きドメイン）
- Streamlit Community Cloud は標準で HTTPS のため追加設定不要
- モバイル端末では背面カメラがデフォルトで選択される（ブラウザ依存）
- 撮影画像はメモリ上のみ保持し、サーバーに保存しない

---

### F-010: 名刺読み取りテンプレート

名刺画像から構造化された連絡先情報を自動抽出する専用テンプレート機能。通常のOCRとは異なり、各項目をフィールド単位で抽出し、編集・エクスポート可能な形式で出力する。

#### 抽出フィールド定義

| フィールド名 | 英語キー | データ型 | 備考 |
|-------------|---------|---------|------|
| 氏名 | name | string | 姓名を結合したフルネーム |
| 氏名（フリガナ） | name_kana | string | フリガナ表記がある場合 |
| 会社名 | company | string | |
| 部署 | department | string | |
| 役職 | title | string | |
| 電話番号 | phone | string[] | 複数番号対応 |
| 携帯電話 | mobile | string | |
| FAX | fax | string | |
| メール | email | string[] | 複数アドレス対応 |
| Webサイト | website | string | |
| 住所 | address | string | 郵便番号含む |

#### APIプロンプト設計

名刺テンプレート選択時は、以下の構造化プロンプトをGemini APIに送信する。

```python
BUSINESS_CARD_PROMPT = """
この名刺画像から以下の情報を読み取り、
JSON形式で出力してください。
読み取れない項目はnullとしてください。

出力フォーマット:
{"name": "", "name_kana": "", "company": "",
 "department": "", "title": "",
 "phone": [], "mobile": "", "fax": "",
 "email": [], "website": "", "address": ""}
"""
```

#### 結果表示・編集UI

| 項目 | 詳細 |
|------|------|
| 結果表示形式 | フィールド別の`st.text_input`で一覧表示（編集可能） |
| レイアウト | 左カラム: 名刺画像、右カラム: 抽出結果フォーム |
| 編集機能 | 各フィールドをユーザーが手動修正可能 |
| JSONプレビュー | `st.json` で構造化データをツリー表示 |

#### エクスポート機能

| 出力形式 | 内容 | 実装方法 |
|----------|------|----------|
| CSV | 全フィールドをカラムとした1行データ | csvモジュール + `st.download_button` |
| JSON | 構造化データをそのまま出力 | `json.dumps` + `st.download_button` |
| vCard (.vcf) | 連絡先アプリにインポート可能な形式 | vCard 3.0形式で生成 |

#### vCard出力例

```
BEGIN:VCARD
VERSION:3.0
N:山田;太郎;;;
FN:山田 太郎
ORG:株式会社○○;営業部
TITLE:部長
TEL;TYPE=WORK:03-1234-5678
TEL;TYPE=CELL:090-1234-5678
EMAIL:taro.yamada@example.co.jp
URL:https://www.example.co.jp
ADR;TYPE=WORK:;;港区六本木1-1-1;東京都;;〒106-0032;日本
END:VCARD
```

#### バッチ名刺処理

複数の名刺画像を連続で処理し、結果を一括管理する機能。

- 複数画像アップロードまたは連続カメラ撮影に対応
- 全名刺の抽出結果をテーブル形式で一覧表示（`st.dataframe`）
- 一括CSVダウンロードで連絡先リストを作成
- 個別のvCardファイルをZIPでまとめてダウンロード

#### エラーハンドリング

| エラーケース | 対応 |
|--------------|------|
| JSONパース失敗 | APIレスポンスがJSON形式でない場合、リトライ（最大3回）後プレーンテキストで表示 |
| 名刺以外の画像 | APIが抽出できない場合、「名刺が検出できませんでした」と表示し通常OCRへの切替を提案 |
| 部分的な抽出失敗 | nullフィールドをハイライト表示し、ユーザーに手動入力を促す |

---

## 画面設計

### メイン画面レイアウト

アプリケーションは単一ページ構成とし、以下のセクションで構成する。

| セクション | 内容 | Streamlitコンポーネント |
|------------|------|-------------------------|
| ヘッダー | アプリタイトル・説明文 | `st.title`, `st.caption` |
| サイドバー | APIキー入力・テンプレート選択・オプション | `st.sidebar` |
| 入力タブ | 「ファイルアップロード」/「カメラ撮影」切替 | `st.tabs` |
| アップロード | ファイルアップロードエリア | `st.file_uploader` |
| カメラ | カメラ撮影エリア | `st.camera_input` |
| プレビュー | アップロード/撮影画像のサムネイル表示 | `st.image`, `st.columns` |
| 実行ボタン | OCR処理開始ボタン | `st.button` |
| 結果表示 | OCR結果または名刺抽出フォーム | `st.text_area` / `st.text_input` |
| ダウンロード | TXT / CSV / JSON / vCard ダウンロード | `st.download_button` |

---

### ユーザーフロー（通常OCR）

1. ユーザーがサイドバーでGemini APIキーを入力する
2. テンプレートを選択する（通常OCR / 名刺読み取り）
3. 入力タブで「ファイルアップロード」または「カメラ撮影」を選択する
4. 画像をアップロードまたは撮影する
5. プレビューで画像を確認する
6. 「OCR実行」ボタンをクリックする
7. APIが処理を実行し、結果が表示される
8. 結果をコピーまたはダウンロードする

---

### ユーザーフロー（名刺読み取り）

1. サイドバーでテンプレート「名刺読み取り」を選択する
2. 名刺画像をアップロードまたはカメラで撮影する
3. 「名刺読み取り実行」ボタンをクリックする
4. 抽出結果がフィールド別に表示される
5. 必要に応じて各フィールドを編集する
6. CSV / JSON / vCard 形式でダウンロードする

---

## 非機能要件

| カテゴリ | 要件 |
|----------|------|
| パフォーマンス | APIレスポンス時間: 30秒以内（一般的な画像）、画像前処理: 2秒以内 |
| セキュリティ | APIキーのセキュアな取り扱い（セッション限定保存、非表示入力）、アップロード画像はサーバーに永続保存しない |
| 可用性 | Streamlit Community CloudのSLAに準拠、エラー時のリトライ機構実装 |
| ユーザビリティ | レスポンシブデザイン（モバイル対応）、日本語 UI、直感的な操作フロー |
| 対応ブラウザ | Chrome, Firefox, Safari, Edge（最新版） |

---

## エラーハンドリング

以下のエラーケースとその対応を定義する。

| エラーケース | 検出方法 | ユーザーへの対応 |
|--------------|----------|------------------|
| 非対応ファイル形式 | MIMEタイプ・拡張子チェック | 対応形式を案内するエラーメッセージ |
| ファイルサイズ超過 | アップロード時にサイズ検証 | 上限サイズを明示した警告 |
| APIキー未設定 | 実行前バリデーション | APIキーの設定を促すメッセージ |
| APIキー無効 | Gemini APIの401/403レスポンス | キーの確認を促すエラー |
| APIレート制限 | Gemini APIの429レスポンス | 時間をおいてリトライを促す |
| APIタイムアウト | リクエストタイムアウト検出 | 再実行を促すメッセージ |
| 文字読み取り不可 | APIレスポンス内容判定 | 画像の品質確認を促すメッセージ |

---

## ディレクトリ構成

```
ocr-app/
├── app.py                  # メインアプリケーション
├── requirements.txt        # 依存パッケージ
├── .streamlit/
│   ├── config.toml         # Streamlit設定
│   └── secrets.toml        # APIキー（ローカル開発用）
├── utils/
│   ├── ocr_processor.py    # OCR処理モジュール
│   ├── image_handler.py    # 画像前処理モジュール
│   ├── camera_handler.py   # カメラ入力処理モジュール
│   ├── vcard_generator.py  # vCard生成モジュール
│   └── config.py           # 設定値管理
├── templates/
│   ├── base_ocr.py         # 通常OCRプロンプト定義
│   └── business_card.py    # 名刺テンプレート定義
├── .env                    # 環境変数（ローカル）
└── README.md               # プロジェクト説明
```

---

## 依存パッケージ

| パッケージ | バージョン | 用途 |
|------------|------------|------|
| streamlit | >=1.30.0 | Web UI フレームワーク |
| google-genai | >=1.0.0 | Google Gemini API クライアント |
| Pillow | >=10.0.0 | 画像前処理・バリデーション |
| python-dotenv | >=1.0.0 | 環境変数読み込み |

---

## 今後の拡張予定

将来的に以下の機能拡張を検討する。

| 優先度 | 機能 | 説明 |
|--------|------|------|
| 高 | PDF対応 | PDFファイルの各ページを画像化してOCR処理 |
| 高 | バッチ処理 | 複数画像の一括 OCR と結果統合 |
| 中 | テンプレート拡張 | レシート・請求書・領収書等の専用テンプレート追加 |
| 中 | 履歴管理 | 過去OCR結果の保存・検索機能 |
| 中 | API使用量表示 | トークン数・コストの見積もり表示 |
| 低 | 多言語翻訳 | OCR結果の自動翻訳機能 |
| 低 | ユーザー認証 | ログイン機能と個人設定の保存 |

---

## 制約事項・前提条件

- 本アプリケーションの利用にはGoogleの有効なGemini APIキーが必要である
- OCR精度はGoogle Gemini 2.0 Flashモデルの性能に依存する
- 手書き文字の読み取り精度は印刷文字と比較して低下する可能性がある
- API利用に伴う費用はユーザー負担となる（Googleの従量課金、無料枠あり）
- 大容量画像の処理時はAPIレスポンス時間が長くなる場合がある
- Streamlit Community Cloudの無料プランではリソースに制限がある
